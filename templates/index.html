<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äººæ•¸çµ±è¨ˆåœ–è¡¨</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
      --bg-secondary: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --card-bg: #ffffff;
      --navbar-bg: #6366f1;
      --border-color: #e5e7eb;
      --shadow-color: rgba(99,102,241,0.10);
      --shadow-hover: rgba(99,102,241,0.18);
    }

    [data-theme="dark"] {
      --bg-primary: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      --bg-secondary: #374151;
      --text-primary: #ffffff;
      --text-secondary: #e5e7eb;
      --card-bg: #374151;
      --navbar-bg: #4f46e5;
      --border-color: #4b5563;
      --shadow-color: rgba(0,0,0,0.3);
      --shadow-hover: rgba(0,0,0,0.5);
    }

    body { 
      font-family: 'Inter', 'Noto Sans TC', 'PingFang TC', 'Heiti TC', Arial, sans-serif; 
      background: var(--bg-primary); 
      min-height: 100vh; 
      color: var(--text-primary);
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    .navbar { 
      background: var(--navbar-bg); 
      transition: background 0.3s ease;
    }
    
    .navbar-brand, .nav-link, .navbar-text { 
      color: #fff !important; 
      font-weight: 700; 
      letter-spacing: 1px; 
    }
    
    .hero { 
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80') center/cover no-repeat; 
      color: #fff; 
      padding: 4rem 2rem 3rem 2rem; 
      border-radius: 1.5rem; 
      margin-top: 2rem; 
      box-shadow: 0 4px 24px var(--shadow-color); 
      text-shadow: 0 2px 8px rgba(0,0,0,0.15); 
    }
    
    .hero h1 { font-size: 2.6rem; font-weight: 700; }
    .hero p { font-size: 1.2rem; margin-top: 1rem; }
    
    .region-select { max-width: 350px; margin: 2rem auto 0.5rem auto; }
    
    .toolbar { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: .5rem; 
      margin: 0 auto 1.5rem auto; 
      max-width: 1100px; 
      flex-wrap: wrap;
    }
    
    .toolbar-left {
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    
    .card { 
      border-radius: 1.5rem; 
      box-shadow: 0 4px 24px var(--shadow-color); 
      border: none; 
      margin-bottom: 2rem; 
      transition: transform 0.15s, box-shadow 0.15s, background-color 0.3s ease; 
      background: var(--card-bg);
    }
    
    .card:hover { 
      transform: translateY(-4px) scale(1.01); 
      box-shadow: 0 8px 32px var(--shadow-hover); 
    }
    
    .card h4 { color: #6366f1; font-weight: 700; }
    
    /* Dark mode text improvements */
    [data-theme="dark"] .card h4 { 
      color: #818cf8; 
    }
    
    [data-theme="dark"] .text-muted { 
      color: #d1d5db !important; 
    }
    
    [data-theme="dark"] .alert-info { 
      background-color: #1e40af; 
      border-color: #3b82f6; 
      color: #ffffff; 
    }
    
    [data-theme="dark"] .alert-light { 
      background-color: #4b5563; 
      border-color: #6b7280; 
      color: #ffffff; 
    }
    
    [data-theme="dark"] .form-label { 
      color: #ffffff; 
    }
    
    [data-theme="dark"] .form-control { 
      background-color: #4b5563; 
      border-color: #6b7280; 
      color: #ffffff; 
    }
    
    [data-theme="dark"] .form-control:focus { 
      background-color: #4b5563; 
      border-color: #818cf8; 
      color: #ffffff; 
      box-shadow: 0 0 0 0.2rem rgba(129, 140, 248, 0.25); 
    }
    
    [data-theme="dark"] .form-select { 
      background-color: #4b5563; 
      border-color: #6b7280; 
      color: #ffffff; 
    }
    
    [data-theme="dark"] .form-select:focus { 
      background-color: #4b5563; 
      border-color: #818cf8; 
      color: #ffffff; 
      box-shadow: 0 0 0 0.2rem rgba(129, 140, 248, 0.25); 
    }
    
    /* Dark mode - make titles and labels white for better visibility */
    [data-theme="dark"] #rate-display h5 { 
      color: #ffffff !important; 
    }
    
    [data-theme="dark"] #rate-display h6 { 
      color: #ffffff !important; 
    }
    
    [data-theme="dark"] #rate-display .small { 
      color: #d1d5db !important; 
    }
    
    /* Also target the specific sections */
    [data-theme="dark"] .rate-display h5 { 
      color: #ffffff !important; 
    }
    
    [data-theme="dark"] .rate-display h6 { 
      color: #ffffff !important; 
    }

    /* Dark mode for Customize Dashboard modal */
    [data-theme="dark"] .modal-content {
      background-color: #374151 !important;
      color: #ffffff !important;
    }

    [data-theme="dark"] .modal-header {
      border-bottom-color: #6b7280 !important;
    }

    [data-theme="dark"] .modal-footer {
      border-top-color: #6b7280 !important;
    }

    [data-theme="dark"] .modal-title,
    [data-theme="dark"] .modal-body h6,
    [data-theme="dark"] .modal-body .form-label,
    [data-theme="dark"] .modal-body .form-check-label {
      color: #ffffff !important;
    }
    
    .footer { 
      text-align: center; 
      color: var(--text-secondary); 
      font-size: 1em; 
      margin-top: 3em; 
      padding: 1.5em 0 0.5em 0; 
      background: var(--bg-secondary); 
      border-top: 1px solid var(--border-color); 
      border-radius: 1.5rem 1.5rem 0 0; 
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    /* Dark mode toggle button */
    .theme-toggle {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .theme-toggle:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-1px);
    }
    
    /* Loading states */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 1.5rem;
      z-index: 10;
    }
    
    [data-theme="dark"] .loading-overlay {
      background: rgba(55,65,81,0.9);
    }
    
    .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.3rem solid #f3f3f3;
      border-top: 0.3rem solid #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Chart container with export functionality */
    .chart-container {
      position: relative;
      display: inline-block;
    }
    
    .chart-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .chart-container:hover .chart-actions {
      opacity: 1;
    }
    
    .export-btn {
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      padding: 0.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background 0.3s ease;
    }
    
    .export-btn:hover {
      background: rgba(0,0,0,0.9);
    }
    
    /* Mobile improvements */
    @media (max-width: 767px) { 
      .hero { 
        padding: 2rem 1rem 1.5rem 1rem; 
        margin-top: 1rem;
      } 
      
      .hero h1 {
        font-size: 2rem;
      }
      
      .hero p {
        font-size: 1rem;
      }
      
      .card { 
        margin-bottom: 1.2rem; 
        border-radius: 1rem;
      }
      
      .toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }
      
      .toolbar-left, .toolbar-right {
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .chart-actions {
        position: static;
        opacity: 1;
        justify-content: center;
        margin-top: 1rem;
      }
      
      .export-btn {
        background: #6366f1;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }
      
      .export-btn:hover {
        background: #4f46e5;
      }
    }
    
    @media (max-width: 576px) {
      .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      
      .hero {
        padding: 1.5rem 1rem;
        border-radius: 1rem;
      }
      
      .card {
        padding: 1.5rem !important;
      }
      
      .toolbar-left, .toolbar-right {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="#">æ•™æœƒçµ±è¨ˆ</a>
      <div class="d-flex align-items-center gap-3">
        <span class="navbar-text">äººæ•¸èˆ‡è² æ“”åœ–è¡¨</span>
        <button class="theme-toggle" id="theme-toggle" title="åˆ‡æ›ä¸»é¡Œ">
          <span id="theme-icon">ğŸŒ™</span>
        </button>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="hero text-center">
      <h1>äººæ•¸çµ±è¨ˆåœ–è¡¨</h1>
      <p>å³æ™‚æŒæ¡å„å¤§å€çš„å¬æœƒç”Ÿæ´»äººæ•¸èˆ‡è² æ“”é ˜å—ç¨‹åº¦</p>
    </div>

    <!-- Container for dynamic alerts -->
    <div id="alert-container" class="container px-0"></div>

    <form method="get" class="region-select">
      <label for="region" class="form-label fw-bold">é¸æ“‡å¤§å€ï¼š</label>
      <select name="region" id="region" class="form-select">
        {% for r in regions %}
          <option value="{{ r }}" {% if r == region %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
    </form>
    <div class="toolbar">
      <div class="toolbar-left">
      <!-- Upload Button -->
      <!-- <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadModal">
        ä¸Šå‚³èˆ‡åˆ†æ
      </button> -->
        <button type="button" class="btn btn-outline-info" id="refresh-data-btn" title="é‡æ–°æ•´ç†è³‡æ–™">
          ğŸ”„ é‡æ–°æ•´ç†
        </button>
      </div>
      <div class="toolbar-right">
      <!-- Subdistrict Button (conditional) -->
      {% if subdistrict_cards %}
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#subdistrictModal">
          æŸ¥çœ‹æ‰€æœ‰å°å€åœ–è¡¨
        </button>
      {% endif %}
        <button type="button" class="btn btn-outline-info" id="dashboard-customize-btn" title="è‡ªè¨‚å„€è¡¨æ¿" data-bs-toggle="modal" data-bs-target="#dashboardCustomizeModal">
          âš™ï¸ è‡ªè¨‚
        </button>
        <button type="button" class="btn btn-outline-secondary" id="export-all-btn" title="åŒ¯å‡ºæ‰€æœ‰åœ–è¡¨">
          ğŸ“Š åŒ¯å‡ºåœ–è¡¨
        </button>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-md-6">
        <div class="card p-4 position-relative" id="attendance-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0" id="attendance-card-title">ğŸ‘¥ {{ region }} - å¬æœƒç”Ÿæ´»äººæ•¸</h4>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleComments('attendance')" title="æ–°å¢å‚™è¨»">
              ğŸ’¬
            </button>
          </div>
          <div class="comments-section d-none" id="attendance-comments">
            <div class="mb-2">
              <textarea class="form-control form-control-sm" placeholder="æ–°å¢å‚™è¨»..." id="attendance-comment-input"></textarea>
              <button class="btn btn-sm btn-primary mt-1" onclick="addComment('attendance')">æ–°å¢å‚™è¨»</button>
            </div>
            <div id="attendance-comments-list"></div>
          </div>
          {% if attendance_chart and attendance_chart|length > 0 %}
            <div class="chart-container">
            {% if subdistrict_cards %}
              <a href="#" data-bs-toggle="modal" data-bs-target="#subdistrictModal" title="æŸ¥çœ‹æ‰€æœ‰å°å€åœ–è¡¨">
                <img id="attendance-chart-img" src="{{ url_for('static', filename=attendance_chart) }}" class="img-fluid rounded" alt="Attendance Chart">
              </a>
            {% else %}
              <img id="attendance-chart-img" src="{{ url_for('static', filename=attendance_chart) }}" class="img-fluid rounded" alt="Attendance Chart">
            {% endif %}
              <div class="chart-actions">
                <button class="export-btn" onclick="exportChart('attendance-chart-img', '{{ region }}_attendance')" title="åŒ¯å‡ºç‚ºPNG">
                  ğŸ“· PNG
                </button>
              </div>
            </div>
          {% else %}
            <div class="alert alert-info">ç›®å‰æ²’æœ‰æ­¤å¤§å€çš„å‡ºå¸­åœ–è¡¨ï¼Œè«‹å…ˆåŸ·è¡Œåˆ†æè…³æœ¬ç”Ÿæˆåœ–è¡¨ã€‚</div>
          {% endif %}
          <div class="loading-overlay d-none" id="attendance-loading">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4 position-relative" id="burden-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0" id="burden-card-title">ğŸ’¡ {{ region }} - è² æ“”é ˜å—ç¨‹åº¦</h4>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleComments('burden')" title="æ–°å¢å‚™è¨»">
              ğŸ’¬
            </button>
          </div>
          <div class="comments-section d-none" id="burden-comments">
            <div class="mb-2">
              <textarea class="form-control form-control-sm" placeholder="æ–°å¢å‚™è¨»..." id="burden-comment-input"></textarea>
              <button class="btn btn-sm btn-primary mt-1" onclick="addComment('burden')">æ–°å¢å‚™è¨»</button>
            </div>
            <div id="burden-comments-list"></div>
          </div>
          {% if burden_chart and burden_chart|length > 0 %}
            <div class="chart-container">
            <img id="burden-chart-img" src="{{ url_for('static', filename=burden_chart) }}" class="img-fluid rounded" alt="Burden Chart">
              <div class="chart-actions">
                <button class="export-btn" onclick="exportChart('burden-chart-img', '{{ region }}_burden')" title="åŒ¯å‡ºç‚ºPNG">
                  ğŸ“· PNG
                </button>
              </div>
            </div>
          {% else %}
            <div class="alert alert-info">ç›®å‰æ²’æœ‰æ­¤å¤§å€çš„è² æ“”åœ–è¡¨ï¼Œè«‹å…ˆåŸ·è¡Œåˆ†æè…³æœ¬ç”Ÿæˆåœ–è¡¨ã€‚</div>
          {% endif %}
          <div class="loading-overlay d-none" id="burden-loading">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Rate Display Section -->
    <div class="row justify-content-center mt-3 g-4">
      <div class="col-lg-10 mx-auto">
        <div class="card p-4">
          <div class="d-flex justify-content-center align-items-center gap-3 mb-4 flex-wrap">
            <label for="base_number_input" class="form-label mb-0 h5">åŸºæ•¸:</label>
            <input type="number" class="form-control form-control-lg text-center" id="base_number_input" value="{{ base_number }}" min="1" style="max-width: 150px;">
            <button class="btn btn-primary" id="calculate-rates-btn">
              <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              <span class="button-text">å„²å­˜ä¸¦è¨ˆç®—</span>
            </button>
          </div>
          <div id="rate-display" class="row gy-4">
            <!-- Sabbath Growth Rate -->
            <div class="col-12 text-center">
              <h5 class="text-muted mb-3">ä¸»æ—¥ç¹å¢ç‡ <small class="fw-normal">(ç›¸å°æ–¼åŸºæº–äººæ•¸)</small></h5>
              <div class="row">
                <div class="col-6 border-end">
                  <h6>æœ€æ–°ä¸€é€±</h6>
                  <p id="sabbath-growth-rate" class="fs-2 fw-bold" style="color: #c0392b;">--%</p>
                  <small class="text-muted">äººæ•¸: <span id="sabbath-latest-count">--</span></small>
                </div>
                <div class="col-6">
                  <h6>æ‰€æœ‰é€±å¹³å‡</h6>
                  <p id="avg-sabbath-growth-rate" class="fs-2 fw-bold" style="color: #c0392b;">--%</p>
                  <small class="text-muted">å¹³å‡: <span id="sabbath-avg-count">--</span></small>
                </div>
              </div>
            </div>

            <hr class="my-4">

            <!-- Core Activities Participation Rate -->
            <div class="col-12 text-center">
              <h5 class="text-muted mb-3">åˆ°æœƒåƒèˆ‡ç‡ <small class="fw-normal">(ä½”åŸºæº–äººæ•¸)</small></h5>
              <div class="row gy-3">
                {% for key, name, color in [('å°æ’', 'å°æ’', '#f39c12'), ('æ™¨èˆˆ', 'æ™¨èˆˆ', '#27ae60'), ('ç¦±å‘Š', 'ç¦±å‘Š', '#2980b9')] %}
                <div class="col-md-6 col-lg-4">
                  <h6>{{ name }}</h6>
                  <div class="d-flex justify-content-center align-items-baseline gap-3">
                    <div>
                      <p id="latest-{{ key }}-rate" class="fs-4 fw-bold mb-0" data-color="{{ color }}">--%</p>
                      <small class="text-muted">æœ€æ–°: <span id="latest-{{ key }}-count">--</span></small>
                    </div>
                    <div>
                      <p id="avg-{{ key }}-rate" class="fs-4 fw-bold mb-0" data-color="{{ color }}" style="opacity: 0.7;">--%</p>
                      <small class="text-muted">å¹³å‡: <span id="avg-{{ key }}-count">--</span></small>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Upload -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadModalLabel">ğŸ“¤ ä¸Šå‚³èˆ‡åˆ†æå ±è¡¨</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted">é¸æ“‡ä¸€å€‹æˆ–å¤šå€‹å ±å‘Šæª”æ¡ˆï¼ˆ.xls, .xlsxï¼‰é€²è¡Œä¸Šå‚³ã€‚åˆ†æå°‡æœƒè‡ªå‹•åŸ·è¡Œã€‚</p>
            <form method="post" action="{{ url_for('upload_files') }}" enctype="multipart/form-data" id="upload-form">
                <div class="mb-3">
                  <input class="form-control" type="file" name="files[]" multiple="true" accept=".xls,.xlsx" required>
                </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            <button form="upload-form" type="submit" class="btn btn-primary" id="upload-submit-btn">
              <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              <span class="button-text">ä¸Šå‚³ä¸¦åˆ†æ</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Dashboard Customization -->
    <div class="modal fade" id="dashboardCustomizeModal" tabindex="-1" aria-labelledby="dashboardCustomizeModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="dashboardCustomizeModalLabel">âš™ï¸ è‡ªè¨‚å„€è¡¨æ¿</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <h6>é¡¯ç¤ºçš„åœ–è¡¨ï¼š</h6>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="show-attendance" checked>
                  <label class="form-check-label" for="show-attendance">
                    ğŸ‘¥ å¬æœƒç”Ÿæ´»äººæ•¸åœ–è¡¨
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="show-burden" checked>
                  <label class="form-check-label" for="show-burden">
                    ğŸ’¡ è² æ“”é ˜å—ç¨‹åº¦åœ–è¡¨
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="show-rates" checked>
                  <label class="form-check-label" for="show-rates">
                    ğŸ“Š æ¯”ç‡çµ±è¨ˆå€å¡Š
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <h6>é¡¯ç¤ºçš„æŒ‡æ¨™ï¼š</h6>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="show-main" checked>
                  <label class="form-check-label" for="show-main">
                    ğŸ  ä¸»æ—¥
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="show-small-group" checked>
                  <label class="form-check-label" for="show-small-group">
                    ğŸ‘¥ å°æ’
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="show-morning" checked>
                  <label class="form-check-label" for="show-morning">
                    ğŸŒ… æ™¨èˆˆ
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="show-prayer" checked>
                  <label class="form-check-label" for="show-prayer">
                    ğŸ™ ç¦±å‘Š
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="applyDashboardCustomization()">å¥—ç”¨è¨­å®š</button>
          </div>
        </div>
      </div>
    </div>


    <!-- Modal: Subdistrict Charts -->
    {% if subdistrict_cards %}
      <div class="modal fade" id="subdistrictModal" tabindex="-1" aria-labelledby="subdistrictModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="subdistrictModalLabel">{{ region }} - æ‰€æœ‰å°å€åœ–è¡¨</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-4">
                {% for c in subdistrict_cards %}
                  <div class="col-lg-6">
                    <div class="card p-3">
                      <h6 class="mb-2">ğŸ“ {{ c.name }}</h6>
                      <div class="small text-secondary">å¬æœƒç”Ÿæ´»äººæ•¸</div>
                      {% if c.has_attendance %}
                        <div class="chart-container">
                          <img src="{{ url_for('static', filename=c.attendance_chart) }}" class="img-fluid rounded mb-2" alt="{{ c.name }} Attendance" id="sub-{{ c.name }}-attendance">
                          <div class="chart-actions">
                            <button class="export-btn" onclick="exportChart('sub-{{ c.name }}-attendance', '{{ region }}_{{ c.name }}_attendance')" title="åŒ¯å‡ºç‚ºPNG">
                              ğŸ“· PNG
                            </button>
                          </div>
                        </div>
                      {% else %}
                        <div class="alert alert-light border">å°šç„¡å‡ºå¸­åœ–è¡¨</div>
                      {% endif %}
                      <div class="small text-secondary">è² æ“”é ˜å—ç¨‹åº¦</div>
                      {% if c.has_burden %}
                        <div class="chart-container">
                          <img src="{{ url_for('static', filename=c.burden_chart) }}" class="img-fluid rounded" alt="{{ c.name }} Burden" id="sub-{{ c.name }}-burden">
                          <div class="chart-actions">
                            <button class="export-btn" onclick="exportChart('sub-{{ c.name }}-burden', '{{ region }}_{{ c.name }}_burden')" title="åŒ¯å‡ºç‚ºPNG">
                              ğŸ“· PNG
                            </button>
                          </div>
                        </div>
                      {% else %}
                        <div class="alert alert-light border">å°šç„¡è² æ“”åœ–è¡¨</div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="footer">Â© 2025 æ•™æœƒäººæ•¸çµ±è¨ˆ Dashboard</div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- AJAX File Upload Logic ---
    const uploadForm = document.getElementById('upload-form');
    const submitBtn = document.getElementById('upload-submit-btn');
    const spinner = submitBtn.querySelector('.spinner-border');
    const buttonText = submitBtn.querySelector('.button-text');
    const uploadModalEl = document.getElementById('uploadModal');
    const uploadModal = bootstrap.Modal.getInstance(uploadModalEl) || new bootstrap.Modal(uploadModalEl);
    const alertContainer = document.getElementById('alert-container');

    function resetButton() {
      submitBtn.disabled = false;
      spinner.classList.add('d-none');
      buttonText.textContent = 'ä¸Šå‚³ä¸¦åˆ†æ';
    }

    uploadForm.addEventListener('submit', function(event) {
      event.preventDefault();

      // Show loading state
      submitBtn.disabled = true;
      spinner.classList.remove('d-none');
      buttonText.textContent = 'åˆ†æä¸­...';
      alertContainer.innerHTML = ''; // Clear previous alerts

      const formData = new FormData(uploadForm);

      fetch("{{ url_for('upload_files') }}", {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        const alertType = data.status === 'success' ? 'alert-success' : 'alert-danger';
        const messagesHtml = data.messages.map(msg => `<div>${msg}</div>`).join('');
        const alertHtml = `
          <div class="alert ${alertType} alert-dismissible fade show mt-3" role="alert">
            ${messagesHtml}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
        alertContainer.innerHTML = alertHtml;

        if (data.status === 'success') {
          uploadModal.hide();
          // Reload the page after a delay to show the new charts
          setTimeout(() => window.location.reload(), 2000);
        } else {
          resetButton(); // Re-enable button on failure
        }
      })
      .catch(error => {
        console.error('Upload Error:', error);
        alertContainer.innerHTML = `<div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">ä¸Šå‚³å¤±æ•—ï¼Œç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ã€‚<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
        resetButton();
      });
    });

    // Reset button if modal is closed manually during an upload
    uploadModalEl.addEventListener('hidden.bs.modal', resetButton);

    // --- Rate Calculation via API ---
    document.addEventListener('DOMContentLoaded', function() {
      const calculateBtn = document.getElementById('calculate-rates-btn');
      if (!calculateBtn) return;
      
      const baseNumberInput = document.getElementById('base_number_input');
      const regionSelect = document.getElementById('region');
      const alertContainer = document.getElementById('alert-container');

      const btnSpinner = calculateBtn.querySelector('.spinner-border');
      const btnText = calculateBtn.querySelector('.button-text');

      function loadBaseNumberForRegion(region) {
        const storageKey = `baseNumber_${region}`;
        const savedBaseNumber = localStorage.getItem(storageKey);
        if (savedBaseNumber) {
          baseNumberInput.value = savedBaseNumber;
        }
      }

      async function updateRates() {
        const baseNumber = baseNumberInput.value;
        const region = regionSelect.value;

        calculateBtn.disabled = true;
        btnSpinner.classList.remove('d-none');
        btnText.textContent = 'è¨ˆç®—ä¸­...';

        // --- Save base number to localStorage ---
        localStorage.setItem(`baseNumber_${region}`, baseNumber);

        try {
          const response = await fetch(`/calculate_rates?base_number=${baseNumber}&region=${region}`);
          const data = await response.json();

          if (response.ok) {
            const rates = data.rates;
            const setText = (id, value, isRate = false) => {
              const el = document.getElementById(id);
              if (el) {
                if (isFinite(value)) {
                  el.textContent = isRate ? `${value.toFixed(1)}%` : value.toFixed(1);
                } else {
                  el.textContent = isRate ? '--%' : '--';
                }
              }
            };

            // Update Sabbath
            const sabbathData = rates['ä¸»æ—¥'] || {};
            setText('sabbath-latest-count', sabbathData.latest_count || 0);
            setText('sabbath-avg-count', sabbathData.avg_count || 0);
            setText('sabbath-growth-rate', sabbathData.latest_rate, true);
            setText('avg-sabbath-growth-rate', sabbathData.avg_rate, true);

            // Update other metrics
            for (const key of ['å°æ’', 'æ™¨èˆˆ', 'ç¦±å‘Š']) {
              const metricData = rates[key] || {};
              setText(`latest-${key}-count`, metricData.latest_count || 0);
              setText(`avg-${key}-count`, metricData.avg_count || 0);
              setText(`latest-${key}-rate`, metricData.latest_rate, true);
              setText(`avg-${key}-rate`, metricData.avg_rate, true);
              
              // Apply colors from data attributes
              const latestEl = document.getElementById(`latest-${key}-rate`);
              const avgEl = document.getElementById(`avg-${key}-rate`);
              if (latestEl && latestEl.dataset.color) {
                latestEl.style.color = latestEl.dataset.color;
              }
              if (avgEl && avgEl.dataset.color) {
                avgEl.style.color = avgEl.dataset.color;
              }
            }
          } else {
            alertContainer.innerHTML = `<div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">${data.message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
          }
        } catch (error) {
          console.error('Rate calculation error:', error);
          alertContainer.innerHTML = `<div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">è¨ˆç®—æ¯”ç‡æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤ã€‚<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
        } finally {
          calculateBtn.disabled = false;
          btnSpinner.classList.add('d-none');
          btnText.textContent = 'å„²å­˜ä¸¦è¨ˆç®—';
        }
      }

      // --- AJAX Region Switching ---
      const attendanceChartImg = document.getElementById('attendance-chart-img');
      const burdenChartImg = document.getElementById('burden-chart-img');
      const subdistrictModalBtn = document.querySelector('button[data-bs-target="#subdistrictModal"]');
      const subdistrictModalBody = document.querySelector('#subdistrictModal .modal-body');
      const subdistrictModalTitle = document.getElementById('subdistrictModalLabel');
      const attendanceCardTitle = document.getElementById('attendance-card-title');
      const burdenCardTitle = document.getElementById('burden-card-title');

      function updateChart(imgElement, url) {
        const card = imgElement.closest('.card');
        const alert = card.querySelector('.alert');
        if (url) {
          imgElement.src = url;
          imgElement.style.display = 'block';
          if (alert) alert.remove();
        } else {
          imgElement.style.display = 'none';
          if (!alert) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info';
            alertDiv.textContent = 'ç›®å‰æ²’æœ‰æ­¤å¤§å€çš„åœ–è¡¨ï¼Œè«‹å…ˆåŸ·è¡Œåˆ†æè…³æœ¬ç”Ÿæˆåœ–è¡¨ã€‚';
            imgElement.parentElement.appendChild(alertDiv);
          }
        }
      }

      async function switchRegion(region) {
        try {
          const response = await fetch(`/region_data?region=${region}`);
          const data = await response.json();

          attendanceCardTitle.textContent = `ğŸ‘¥ ${data.region} - å¬æœƒç”Ÿæ´»äººæ•¸`;
          burdenCardTitle.textContent = `ğŸ’¡ ${data.region} - è² æ“”é ˜å—ç¨‹åº¦`;

          updateChart(attendanceChartImg, data.attendance_chart_url);
          updateChart(burdenChartImg, data.burden_chart_url);

          if (subdistrictModalBtn) {
            subdistrictModalBtn.style.display = data.subdistrict_cards.length > 0 ? 'block' : 'none';
          }
          if (subdistrictModalBody && subdistrictModalTitle) {
            subdistrictModalTitle.textContent = `${data.region} - æ‰€æœ‰å°å€åœ–è¡¨`;
            let modalHtml = '<div class="row g-4">';
            data.subdistrict_cards.forEach(c => {
              modalHtml += `
                <div class="col-lg-6">
                  <div class="card p-3">
                    <h6 class="mb-2">ğŸ“ ${c.name}</h6>
                    <div class="small text-secondary">å¬æœƒç”Ÿæ´»äººæ•¸</div>
                    ${c.has_attendance ? `<img src="${c.attendance_chart}" class="img-fluid rounded mb-2" alt="${c.name} Attendance">` : '<div class="alert alert-light border">å°šç„¡å‡ºå¸­åœ–è¡¨</div>'}
                    <div class="small text-secondary">è² æ“”é ˜å—ç¨‹åº¦</div>
                    ${c.has_burden ? `<img src="${c.burden_chart}" class="img-fluid rounded" alt="${c.name} Burden">` : '<div class="alert alert-light border">å°šç„¡è² æ“”åœ–è¡¨</div>'}
                  </div>
                </div>
              `;
            });
            modalHtml += '</div>';
            subdistrictModalBody.innerHTML = modalHtml;
          }

          const url = new URL(window.location);
          url.searchParams.set('region', region);
          history.pushState({}, '', url);

          loadBaseNumberForRegion(region);
          updateRates();

        } catch (error) {
          console.error('Error switching region:', error);
          alertContainer.innerHTML = '<div class="alert alert-danger">åˆ‡æ›å€åŸŸæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</div>';
        }
      }

      calculateBtn.addEventListener('click', updateRates);

      baseNumberInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          updateRates();
        }
      });

      regionSelect.addEventListener('change', (event) => {
        switchRegion(event.target.value);
      });

      // Initial calculation on page load
      loadBaseNumberForRegion(regionSelect.value);
      updateRates();
    });

    // --- Dark Mode Toggle ---
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const body = document.body;

    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    body.setAttribute('data-theme', savedTheme);
    themeIcon.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';

    themeToggle.addEventListener('click', () => {
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      body.setAttribute('data-theme', newTheme);
      themeIcon.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      localStorage.setItem('theme', newTheme);
    });

    // --- Export Chart Functions ---
    function exportChart(imgId, filename) {
      const img = document.getElementById(imgId);
      if (!img) return;

      // Create canvas to convert image to PNG
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = img.naturalWidth || img.width;
      canvas.height = img.naturalHeight || img.height;
      
      ctx.drawImage(img, 0, 0);
      
      // Convert to blob and download
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }

    // --- Export All Charts ---
    document.getElementById('export-all-btn').addEventListener('click', () => {
      const charts = ['attendance-chart-img', 'burden-chart-img'];
      const region = document.getElementById('region').value;
      
      charts.forEach((chartId, index) => {
        setTimeout(() => {
          const img = document.getElementById(chartId);
          if (img && img.src) {
            const chartType = chartId.includes('attendance') ? 'attendance' : 'burden';
            exportChart(chartId, `${region}_${chartType}`);
          }
        }, index * 500); // Stagger downloads
      });
    });

    // --- Refresh Data Function ---
    document.getElementById('refresh-data-btn').addEventListener('click', () => {
      const attendanceCard = document.getElementById('attendance-card');
      const burdenCard = document.getElementById('burden-card');
      
      // Show loading states
      document.getElementById('attendance-loading').classList.remove('d-none');
      document.getElementById('burden-loading').classList.remove('d-none');
      
      // Simulate refresh (in real implementation, this would trigger data reload)
      setTimeout(() => {
        document.getElementById('attendance-loading').classList.add('d-none');
        document.getElementById('burden-loading').classList.add('d-none');
        
        // Show success message
        const alertContainer = document.getElementById('alert-container');
        alertContainer.innerHTML = `
          <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            è³‡æ–™å·²é‡æ–°æ•´ç†å®Œæˆï¼
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
      }, 2000);
    });

    // --- Enhanced Loading States for Chart Switching ---
    function showChartLoading(cardId) {
      const loadingOverlay = document.getElementById(`${cardId}-loading`);
      if (loadingOverlay) {
        loadingOverlay.classList.remove('d-none');
      }
    }

    function hideChartLoading(cardId) {
      const loadingOverlay = document.getElementById(`${cardId}-loading`);
      if (loadingOverlay) {
        loadingOverlay.classList.add('d-none');
      }
    }

    // --- Enhanced Region Switching with Loading States ---
    const originalSwitchRegion = window.switchRegion;
    window.switchRegion = async function(region) {
      showChartLoading('attendance');
      showChartLoading('burden');
      
      try {
        await originalSwitchRegion(region);
      } finally {
        setTimeout(() => {
          hideChartLoading('attendance');
          hideChartLoading('burden');
        }, 1000);
      }
    };

    // --- Function 9: Customizable Dashboard ---
    function applyDashboardCustomization() {
      const showAttendance = document.getElementById('show-attendance').checked;
      const showBurden = document.getElementById('show-burden').checked;
      const showRates = document.getElementById('show-rates').checked;
      const showMain = document.getElementById('show-main').checked;
      const showSmallGroup = document.getElementById('show-small-group').checked;
      const showMorning = document.getElementById('show-morning').checked;
      const showPrayer = document.getElementById('show-prayer').checked;

      // Toggle chart visibility
      const attendanceCard = document.getElementById('attendance-card');
      const burdenCard = document.getElementById('burden-card');
      const ratesSection = document.querySelector('.row.justify-content-center.mt-3');

      if (attendanceCard) {
        attendanceCard.style.display = showAttendance ? 'block' : 'none';
      }
      if (burdenCard) {
        burdenCard.style.display = showBurden ? 'block' : 'none';
      }
      if (ratesSection) {
        ratesSection.style.display = showRates ? 'block' : 'none';
      }

      // Toggle specific metrics in the rates section
      const metrics = [
        { id: 'sabbath-growth-rate', show: showMain },
        { id: 'latest-å°æ’-rate', show: showSmallGroup },
        { id: 'latest-æ™¨èˆˆ-rate', show: showMorning },
        { id: 'latest-ç¦±å‘Š-rate', show: showPrayer }
      ];

      metrics.forEach(metric => {
        const element = document.getElementById(metric.id);
        if (element) {
          const parent = element.closest('.col-md-6, .col-lg-4');
          if (parent) {
            parent.style.display = metric.show ? 'block' : 'none';
          }
        }
      });

      // Save preferences to localStorage
      const preferences = {
        showAttendance, showBurden, showRates, showMain, showSmallGroup, showMorning, showPrayer
      };
      localStorage.setItem('dashboardPreferences', JSON.stringify(preferences));

      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('dashboardCustomizeModal'));
      modal.hide();

      // Show success message
      const alertContainer = document.getElementById('alert-container');
      alertContainer.innerHTML = `
        <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
          å„€è¡¨æ¿è‡ªè¨‚è¨­å®šå·²å¥—ç”¨ï¼
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
    }

    // Load saved dashboard preferences
    function loadDashboardPreferences() {
      const saved = localStorage.getItem('dashboardPreferences');
      if (saved) {
        const preferences = JSON.parse(saved);
        
        // Apply saved preferences
        document.getElementById('show-attendance').checked = preferences.showAttendance;
        document.getElementById('show-burden').checked = preferences.showBurden;
        document.getElementById('show-rates').checked = preferences.showRates;
        document.getElementById('show-main').checked = preferences.showMain;
        document.getElementById('show-small-group').checked = preferences.showSmallGroup;
        document.getElementById('show-morning').checked = preferences.showMorning;
        document.getElementById('show-prayer').checked = preferences.showPrayer;

        // Apply the settings
        applyDashboardCustomization();
      }
    }



    // --- Function 12: Comment System ---
    function toggleComments(chartType) {
      const commentsSection = document.getElementById(`${chartType}-comments`);
      const commentCount = document.getElementById(`${chartType}-comment-count`);
      
      if (commentsSection.classList.contains('d-none')) {
        commentsSection.classList.remove('d-none');
        loadComments(chartType);
      } else {
        commentsSection.classList.add('d-none');
      }
    }

    function addComment(chartType) {
      const commentInput = document.getElementById(`${chartType}-comment-input`);
      const comment = commentInput.value.trim();
      
      if (!comment) {
        alert('è«‹è¼¸å…¥å‚™è¨»å…§å®¹');
        return;
      }

      const commentData = {
        text: comment,
        timestamp: new Date().toLocaleString('zh-TW'),
        chartType: chartType,
        region: document.getElementById('region').value
      };

      // Save to localStorage
      const comments = JSON.parse(localStorage.getItem('chartComments') || '{}');
      const key = `${chartType}_${commentData.region}`;
      if (!comments[key]) {
        comments[key] = [];
      }
      comments[key].push(commentData);
      localStorage.setItem('chartComments', JSON.stringify(comments));

      // Clear input and reload comments
      commentInput.value = '';
      loadComments(chartType);
      updateCommentCount(chartType);
    }

    function loadComments(chartType) {
      const commentsList = document.getElementById(`${chartType}-comments-list`);
      const region = document.getElementById('region').value;
      const key = `${chartType}_${region}`;
      
      const comments = JSON.parse(localStorage.getItem('chartComments') || '{}');
      const chartComments = comments[key] || [];

      if (chartComments.length === 0) {
        commentsList.innerHTML = '<div class="text-muted small">å°šç„¡å‚™è¨»</div>';
      } else {
        commentsList.innerHTML = chartComments.map((comment, index) => `
          <div class="comment-item border-bottom pb-2 mb-2">
            <div class="d-flex justify-content-between align-items-start">
              <div class="comment-text">${comment.text}</div>
              <div class="d-flex align-items-center gap-2">
                <small class="text-muted">${comment.timestamp}</small>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteComment('${chartType}', ${index})" title="åˆªé™¤å‚™è¨»">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    function updateCommentCount(chartType) {
      const region = document.getElementById('region').value;
      const key = `${chartType}_${region}`;
      const comments = JSON.parse(localStorage.getItem('chartComments') || '{}');
      const chartComments = comments[key] || [];
      
      const countElement = document.getElementById(`${chartType}-comment-count`);
      if (countElement) {
        countElement.textContent = chartComments.length;
      }
    }

    function deleteComment(chartType, commentIndex) {
      const region = document.getElementById('region').value;
      const key = `${chartType}_${region}`;
      const comments = JSON.parse(localStorage.getItem('chartComments') || '{}');
      
      if (comments[key] && comments[key][commentIndex]) {
        // Remove the comment at the specified index
        comments[key].splice(commentIndex, 1);
        localStorage.setItem('chartComments', JSON.stringify(comments));
        
        // Reload comments and update count
        loadComments(chartType);
        updateCommentCount(chartType);
        
        // Show success message
        const alertContainer = document.getElementById('alert-container');
        alertContainer.innerHTML = `
          <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            å‚™è¨»å·²åˆªé™¤ï¼
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadDashboardPreferences();
      
      // Update comment counts after a short delay to ensure DOM is ready
      setTimeout(() => {
        updateCommentCount('attendance');
        updateCommentCount('burden');
      }, 100);
    });

    // Also update comment counts when region changes
    document.getElementById('region').addEventListener('change', function() {
      setTimeout(() => {
        updateCommentCount('attendance');
        updateCommentCount('burden');
      }, 100);
    });
  </script>
</body>
</html>
